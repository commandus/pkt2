pkt2
====

История изменений
-----------------

2017/01/11 Черновик

Назначение
----------

Разбор приходящих пакетов.

Сервер соержит список  поддерживаемых протоколов.

Протокол содержит 

- описание входящего пакета данных, опционально- адреса источника данных и адреса, на который пришел пакет.
- описание извлекаемых в БД данных
- описание исходящего пакета данных, опционально- адрес куда отправить пакет.

```
                                              Файлы
                                            (плагины)
                                          поддерживаемых
                                            протоколов
                                          +------------+
                                          | Протоколы  |
                                          +------------+
                                          | Протокол 1 |
                                          | ...        |
                                          | Протокол N |-----------------+
                                          +------------+  Описание       |
                                                ^        входящего       |
                                   Определение  |         пакета         |
                                    протокола   |            |           |
                                                |            |           |
  Ресивер      Сообщение        Приемник          Парсер    Процессор    | Сообщение           Шлюз
                очередь                                                  |  очередь
 +-------+    +---------+    +------------+    +-------+    +---------+  | +--------+     
 |       |--->| очередь |--->| вх. пакет  |--->| Блоки |    | Выходн. |  | | Запись |    
 +-------+    +---------+    +------------+    +-------+    +---------+  | +--------+    
                                               | int x |    | int sum |  | | sum    |    +-------------+
                                               | int y |--->| = x + y |--->| x1     |--->| Обработчики |
                                               | int z |    |         |  | | z      |    +-------------+
                                               +-------+    +---------+  | +--------+    |             |
                                                              |          +--+            |             |
                                                      Описание|             |            |             |
Трансмимттео              Передатчик         Композер исх. пак|             |            |             |
 +-------+    +----+    +-----------+    +--------------+    +-------+    +---------+    |             |
 |       |<---|    |<---| исх.пакет |<---| "Переменные" |    |Входн. |<---| Запись  |<---|             |
 +-------+    +----+    +-----------+    +--------------+    +-------+    +---------+    +-------------+
                        | uint16 a  |    | float a = x+y|    | x     |                          |
                        | uint32 b  |--->| uint16 b = x |    | y     |                          |
                        | uint32 c  |    | uint32 c = z |    | z     |                   +----------------+
                        +-----------+    +--------------+    +-------+                   | внешняя прогр. |
                                                                                         +----------------+
```




Ответный пакет отправляется по признаку.

## Определение протокола

Протокол отпределяется по Источнику

Описание структуры пакетов

Экземпляр

service
  proto
    packet
      input
      output
    src
      ipv4
      port
    dest  
      ipv4
      port
    external_proc

Сервис
  Название протокола
    Источник
    Входящий пакет
      Корневой элемент (пакет)
        элемент структуры 1
        элемент структуры 2
        ...
        элемент структуры N
    Извлекаемые данные

### Название протокола

cn              отображаемое имя
name            имя для файлов, имен переменных (лат.)
abbr            аббревиатура, "расширение файла"

### Источник

src_proto = tcp | udp
src_addr = IPv4
src_port = 0..
dst_addr = IPv4
dst_port = 0..

Если адрес не указан или равен 0, "0.0.0.0", то пакет с любым адресом.

Если порт не указан или равен 0, то пакет с любым портом.

Если ни один протокол не найден по Источнику, пакет записывается в таблицу необработанных пакеты.

Если Источник дает более одного протокола, поиск делается перебором зарегистрированных протоколов с подходящими источниками.

Если Источник дает более чем одлин протокол, вызывается процедура предварительной обработки пекета каждого проткола, до тех пор, пока процедура не вернет признак валидности пакета.

Процедура предварительной обработки пекета возвращает признак валидности. Если пакет вадиден, он записывается в базу данных.

Если ни один протокол не сообщает о валидности пакета, пакет записывается в таблицу необработанных пакеты.

### Выходный адрес

Тоже самое

### Входящий пакет

#### Элемент структуры (PDU)

Элемент структуры имеет имя, на которое может ссылаться элемент извлекаемых (выходных) данных

##### Обязательные 
name               имя переменной (лат). Это имя может использоваться для получения значений в  
cn                 отображаемое имя
parent             родительский элемент, относительно которого задается положение в пакете (NULL для пакета без вложений)
offset             расположение отнсительно родительского элемента
size               длина в байтах

measure_unit       единица измерения (если не задан values)
measure_unit_rule  правило (формула приведения значения к единице измерения) (если не задан values)
values             строки для флагов или перечислений по порядку. Если задан, measure_unit и measure_unit_rule не действуют.

##### Необязательные 

display            уровень детализации отображения. 0- отображать всегда (по умолчанию), 1- не отображать (не записывать в БД)
preprocess         Предварительная обработка  NONE | MASK [| SHL | SHR...]
preprocess_value   битовая маска(очистка мусора), значение сдвига итд
encoding           дополнительные признаки для преобразоваия типа: BIG_ENDIAN,..
src_type           тип переменной в пакете (например, UINT8) (не больше size)
dst_type           тип переменной в единицах измерения (например, FLOAT)
format             формат преобразования в строку (для определенных типов, например, 8.2f для указания точности)

##### Элемент values

cn                 отображаемое имя флага или перечисления, например, мотор
on                 например, "вкл."
off                например, "выкл."

##### Тип переменной (src_type, dst_type)

...
ENUM
SET
BOOLEAN 	
UINT8 	
UINT16 	
UINT24 	
UINT32 	
UINT40 	
UINT48 	
UINT56 	
UINT64 	
INT8 	
INT16 	
INT32 	
INT64 
IEEE_11073_SFLOAT 	
IEEE_11073_FLOAT 	
FLOAT 	
DOUBLE 	
STRING 	
STRINGZ 	
UINT_STRING 	
BYTES 	
UINT_BYTES
...

